#!/bin/bash

jsonData=$(echo "$1" | base64 --decode > /opt/route48/json.data )

jData=$( cat /opt/route48/json.data | jq -r "to_entries|map(\"\(.key)=\(.value|tostring)\")|.[]")
for conf in ${jData}; do
  eval ${conf}
done

#as base64  ewoJIkFTTiI6ICIxMzk4ODIiLAoJIk9SRyI6ICJGdXNlZElULlRydXN0IiwKCSJQRUVSX0FERFJFU1MiOiAiMjAwMDozMDAwOjQwMDA6NTAwMDo6MiIsCgkiUFJFRklYRVMiOiAiMiIsCgkiUFJFRklYMSI6ICIyMDAxOjIwMDI6MjAwMzoyMDA0OjpcLzQ4IiwKCSJQUkVGSVgyIjogIjIwMDU6MjAwNjoyMDA3OjIwMDg6OlwvNDgiCn0=

function create_new_session {
 set -o pipefail # optional.
        sed -i 's/REPLACE1/AS'$ASN'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf
        sed -i 's/REPLACE2/AS'$ASN'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf
        sed -i 's/REPLACE3/'$PEER_ADDRESS'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf
        sed -i 's/REPLACE4/'$ORG'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf
}

function create_additional_session {
 set -o pipefail # optional.
        sed -i 's/REPLACE1/AS'$ASN'_TB'$1'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf
        sed -i 's/REPLACE2/AS'$ASN'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf
        sed -i 's/REPLACE3/'$PEER_ADDRESS'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf
        sed -i 's/REPLACE4/'$ORG'/g' /opt/route48/bird/PEERS/$ASN/peer_v6.conf

}

function refresh_bird {
 set -o pipefail # optional.
       /etc/init.d/bird6c configure soft;
       /etc/init.d/birdc configure soft;

}

if [[ -e /opt/route48/bird/PEERS/$ASN/peer_v6.conf ]]; then
        numSession=$(cat /opt/route48/bird/PEERS/$ASN/peer_v6.conf | grep 'protocol bgp' | wc -l)
        declare -i numSession
        cat /opt/route48/bird/TEMPLATES/tbPeer.conf >> /opt/route48/bird/PEERS/$ASN/peer_v6.conf
        num=$(($numSession+1))
                create_additional_session $num
fi

if [[ ! -e /opt/route48/bird/PEERS/$ASN/peer_v6.conf ]]; then
        mkdir -p /opt/route48/bird/PEERS/$ASN/;
        cp /opt/route48/bird/TEMPLATES/tbPeer.conf /opt/route48/bird/PEERS/$ASN/peer_v6.conf
                create_new_session
fi

refresh_bird
